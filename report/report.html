<!DOCTYPE html>
<html>
    <head>
        <title>Pivot Demo</title>
        <!-- external libs from cdnjs -->
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.css"/>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

        <!-- PivotTable.js libs -->
        <link rel="stylesheet" type="text/css" href="../pivottable/dist/pivot.css"/>
        <script type="text/javascript" src="../pivottable/dist/pivot.js"></script>
        <style>
            body {font-family: Verdana;}
			table { font-size: 0.9em !important; }
			#details { display: none; }
			#details tbody { background-color: rgba(237, 237, 237, 1); }
			#details tbody tr:nth-child(6n+1), #details tbody tr:nth-child(6n+2), #details tbody tr:nth-child(6n+3) { background-color: rgba(229, 237, 237, 1); }
        </style>
    </head>
    <body>
		<script type="text/javascript">
			function getQueryStringParameterByName( name )
			{
				name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
				var regexS = "[\\?&]"+name+"=([^&#]*)";
				var regex = new RegExp( regexS );
				var results = regex.exec( window.location.href );
				if( results == null )
					return "";
				else
					return decodeURIComponent(results[1].replace(/\+/g, " "));
			}

			function getPlayerOnPosition(data, playerId) {
				var matchingElements = $.grep(data, function(element) {
						return element.Position == playerId
					});
				
				return matchingElements.length > 0 ? matchingElements[0] : {};
			}
			
			function dumpObjectToTable(obj, header) {
				var result = "<table>\n<thead><tr><th colspan='2'>"+header+"</th></tr></thread>\n<tbody>\n";				
				$.each(obj, function (key, value) {
					result += "<tr><td>" + key + "</td><td>" + value + "</td></tr>\n";
				});
				result += "</tbody></table>";
				
				return result;
			}
			
			var player1 = {};
			var player2 = {};
			var player3 = {};

			$(document).ready(function(){
				var scenario = getQueryStringParameterByName("scenario");
				var configFile = "cfg" + scenario + ".json";
				var reportFile = "report" + scenario + ".json";
				if(scenario != "")
				{
					$("#subtitle").append("Scenario: '" + scenario + "'");
				}
				$.getJSON("/mariasek/" + configFile, function(data) {
					player1 = getPlayerOnPosition(data, "player1");
					player2 = getPlayerOnPosition(data, "player2");
					player3 = getPlayerOnPosition(data, "player3");
				});
				$.getJSON("/mariasek/" + reportFile, function(data) {
					//var sum = $.pivotUtilities.aggregatorTemplates.sum;
					//var avg = $.pivotUtilities.aggregatorTemplates.average;
					//var numberFormat = $.pivotUtilities.numberFormat;
					//var intFormat = numberFormat({digitsAfterDecimal: 0});
					
					var playerTotals = {};
					playerTotals[player1.Name] = 0;
					playerTotals[player2.Name] = 0;
					playerTotals[player3.Name] = 0;

					for(var i in data)
					{
						data[i]["Money"] = parseInt(data[i]["Money"]) / 10.0;
						playerTotals[data[i]["Player"]] += data[i]["Money"];
						$("#details").append("<tr><td>"+data[i]["GameId"]+"</td><td>"+data[i]["ConfigId"]+"</td><td>"+data[i]["Player"]+"</td><td>"+data[i]["Typ"]+"</td><td>"+data[i]["Position"]+"</td><td>"+data[i]["Score"]+"</td><td>"+data[i]["Money"]+"</td></tr>");
					}
					$("#config").append("<tr><td>" + dumpObjectToTable(player1, player1.Name + " (total: " + playerTotals[player1.Name].toFixed(2) + ")") + 
										"</td><td>" + dumpObjectToTable(player2, player2.Name + " (total: " + playerTotals[player2.Name].toFixed(2) + ")") +
										"</td><td>" + dumpObjectToTable(player3, player3.Name + " (total: " + playerTotals[player3.Name].toFixed(2) + ")") + "</td></tr>");

					$("#output").pivotUI(
						data, 
						{ 
							rows: ["GameId", "Typ", "Player"], 
							cols: ["ConfigId"],
							vals: ["Money"],
							aggregatorName: "Sum",
							rendererName: "Heatmap"
						}
					);
				});
            });
        </script>

        <h2>Mariasek: Game Report</h2>
		<h5 id="subtitle"></h5>
		
		<table id="config"></table>
		<input type="button" value="Show / Hide details" onclick="$('#details').toggle();" />
		<table id="details" class="ui-widget">
			<thead class="ui-widget-header">
				<th>GameId</th>
				<th>ConfigId</th>
				<th>Player</th>
				<th>Type</th>
				<th>Position</th>
				<th>Score</th>
				<th>Money</th>
			</thead>
			<tbody class="ui-widget-content"></tbody>
		</table>
		<div id="output" style="margin: 10px;">Generating report ...</div>
    </body>
</html>